name: wrapper-qemu

on:
   workflow_run:
     workflows: ["Build"]
     types: [completed]

jobs:
   on-success:
     runs-on: ubuntu-latest
     if: ${{ github.event.workflow_run.conclusion == 'success' }}
     steps:
       - uses: actions/checkout@v4

       - name: Download wrapper-qemu basic image
         run: wget https://github.com/WorldObservationLog/wrapper/releases/download/wrapper-qemu/wrapper.qcow2

       - name: Mount image
         run: |
           sudo modprobe nbd max_part=8
           sudo qemu-nbd --connect=/dev/nbd0 wrapper.qcow2
           sudo mkdir /mnt/wrapper
           sudo mount /dev/nbd0p3 /mnt/wrapper/

       - name: Download latest artifact
         uses: actions/github-script@v6
         with:
           script: |
             let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.payload.workflow_run.id,
             });
             let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
               return artifact.name == "pr_number"
             })[0];
             let download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id,
                archive_format: 'zip',
             });
             let fs = require('fs');
             fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/pr_number.zip`, Buffer.from(download.data));
      
       - name: Unzip to image
         run: |
           sudo mkdir /mnt/wrapper/root/wrapper
           sudo unzip -d /mnt/wrapper/root/wrapper Wrapper.x86_64.*.zip
           
       - name: Unmount image
         run: |
           sudo umount /mnt/wrapper/
           sudo qemu-nbd --disconnect /dev/nbd0
           sudo rmmod nbd
      
       - name: Upload artifact
         uses: actions/upload-artifact@v4
         with:
           name: wrapper-qemu
           path: wrapper.qcow2
